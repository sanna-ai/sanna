# Sanna Constitution: Team Agent
# ─────────────────────────────────────────────────────────────────────
# Strict governance for shared team agents. Narrow direct execution
# with broad escalation requirements. File modification, browsing,
# and all communication require escalation.
#
# EVALUATION ORDER (this matters)
# ================================
# The engine evaluates boundaries in strict priority order and returns
# the FIRST match. Understanding this order is critical to writing
# constitutions that work.
#
#   1. cannot_execute  — checked FIRST, matches TOOL NAMES ONLY
#      → If the tool name matches, verdict is HALT. Done. Nothing
#        else is checked.
#
#   2. must_escalate   — checked SECOND, matches FULL ACTION CONTEXT
#      → If any condition's keywords appear in the tool name + all
#        parameter names + all parameter values, verdict is ESCALATE.
#        Done. Nothing else is checked.
#
#   3. can_execute     — checked THIRD, matches TOOL NAMES ONLY
#      → If the tool name matches, verdict is ALLOW.
#
#   4. default         — if nothing matched, verdict is ALLOW
#      (uncategorized action)
#
# WHY THIS MATTERS
# ────────────────
# A tool in can_execute is STILL subject to must_escalate conditions.
# "exec" is allowed, but exec(command="sudo rm -rf /") hits the
# "sudo" and "rm -rf" escalation conditions BEFORE can_execute fires.
#
# A tool in cannot_execute is NEVER subject to must_escalate conditions.
# If "cron" is in cannot_execute, it's halted immediately — the engine
# never reaches must_escalate to check parameters.
#
# COMMON MISTAKE
# ──────────────
# Putting command patterns in cannot_execute. If you add "crontab" to
# cannot_execute, it only blocks a tool literally named "crontab". An
# agent calling exec(command="crontab -l") sails right through because
# cannot_execute only matches tool names, and the tool name is "exec".
# Move command patterns to must_escalate conditions instead.
#
# RULE OF THUMB
# ─────────────
# Governing what a tool IS → cannot_execute / can_execute (tool names)
# Governing what a tool DOES → must_escalate conditions (parameters)
#

sanna_constitution: "0.1.0"

preamble: |
  This agent is governed by Sanna, an independent AI governance layer.
  Sanna enforces constitutional boundaries and generates cryptographic
  receipts for every tool call decision. When a tool call is blocked
  or escalated, Sanna is the enforcement authority — not the host
  platform. Governance verdicts: ALLOW, ESCALATE (requires human
  approval), HALT (blocked by policy).

identity:
  agent_name: openclaw-team
  domain: team-operations
  description: >-
    Shared team agent with strict governance. Only basic execution and
    web search are directly permitted. File modifications, browsing,
    and all external communication require explicit escalation.
    Process control and infrastructure tools are prohibited.

provenance:
  authored_by: sanna-openclaw
  approved_by:
    - security-team
  approval_date: "2026-02-24"
  approval_method: template

boundaries:
  - id: B001
    description: Agent operates within the team workspace only
    category: scope
    severity: high
  - id: B002
    description: File modifications require escalation
    category: confidentiality
    severity: high
  - id: B003
    description: All external communication requires escalation
    category: safety
    severity: critical
  - id: B004
    description: Infrastructure and process control are prohibited
    category: authorization
    severity: critical

authority_boundaries:
  cannot_execute:
    - process
    - nodes
    - cron
    - gateway
  must_escalate:
    - condition: write
    - condition: edit
    - condition: apply_patch
    - condition: browser
    - condition: web_fetch
    - condition: message
    - condition: sessions_send
    - condition: sessions_spawn

    # Sensitive file reads
    - condition: read .ssh
    - condition: read .sanna/keys
    - condition: read .env
    - condition: read .pem
    - condition: read .key
    - condition: read openclaw.json
    - condition: read authorized_keys
    - condition: read .netrc
    - condition: read .authinfo
  can_execute:
    - exec
    - bash
    - web_search

# ── INVARIANTS ────────────────────────────────────────────────────────
# Cross-cutting safety rules evaluated on every governed tool call.
# These prevent escalation bypass — e.g. an agent routing external
# communication through exec instead of message.
invariants:
  - id: INV_NO_EXTERNAL_COMMS_VIA_EXEC
    rule: "regex_deny pattern: /\\b(curl|wget|sendmail|mail\\b|smtp|nc\\b|ncat|netcat|telnet|ssh|scp|sftp|rsync)\\b/i"
    enforcement: halt
    description: "Block network/messaging commands routed through exec to prevent message escalation bypass"
    severity: critical
    applies_to:
      - exec
      - bash
      - browser

  - id: INV_NO_HTTP_REQUESTS_VIA_EXEC
    rule: "regex_deny pattern: /\\b(https?:\\/\\/|fetch\\(|requests\\.|urllib|http\\.client|smtplib|socket\\.connect)\\b|\\/\\/[a-zA-Z]/i"
    enforcement: halt
    description: "Block HTTP requests and socket connections through exec"
    severity: critical

  - id: INV_NO_SCRIPTED_OUTBOUND
    rule: "regex_deny pattern: /\\b(python[23]?\\s+-c|node\\s+-e|ruby\\s+-e|perl\\s+-e)\\b.*\\b(http|smtp|mail|socket|fetch|request)\\b/i"
    enforcement: halt
    description: "Block inline scripts that make outbound connections"
    severity: critical

  - id: INV_NO_APPLESCRIPT_OUTBOUND
    rule: "regex_deny pattern: /\\b(osascript|applescript|tell\\s+application)\\b/i"
    enforcement: halt
    description: "Block AppleScript execution that could trigger external applications"
    severity: critical

  - id: INV_NO_APP_LAUNCH_VIA_EXEC
    rule: "regex_deny pattern: /\\b(open\\s+mailto|open\\s+-a|xdg-open|start\\s+\\/|cscript|wscript)\\b/i"
    enforcement: halt
    description: "Block launching external applications or mailto links through exec"
    severity: critical

  - id: INV_NO_DNS_EXFILTRATION
    rule: "regex_deny pattern: /\\b(nslookup|dig\\s|host\\s)\\b/i"
    enforcement: halt
    description: "Block DNS lookup commands that could exfiltrate data via hostname encoding"
    severity: critical

  - id: INV_NO_BASH_TCP
    rule: "regex_deny pattern: /\\/dev\\/(tcp|udp)\\//i"
    enforcement: halt
    description: "Block bash built-in TCP/UDP connections via /dev/tcp and /dev/udp"
    severity: critical

  - id: INV_NO_ENCODED_EXEC
    rule: "regex_deny pattern: /\\b(base64|atob|decode)\\b.*\\b(exec|eval|system|popen|subprocess)\\b|\\b(exec|eval|system|popen|subprocess)\\b.*\\b(base64|atob|decode)\\b/i"
    enforcement: halt
    description: "Block encoded payload execution that hides blocked operations behind encoding"
    severity: critical

  - id: INV_NO_PERSISTENCE_WRITE
    rule: "regex_deny pattern: /\\b(LaunchAgents|LaunchDaemons|cron\\.d|crontab|systemd|init\\.d|autostart|startup)\\b|\\.(?:zshrc|bashrc|bash_profile|profile|zprofile)\\b/i"
    enforcement: halt
    description: "Block writes to persistence mechanisms that execute on login or boot"
    severity: critical
    applies_to:
      - exec
      - bash
      - write

  - id: INV_NO_EXFIL_VIA_FETCH
    rule: "regex_deny pattern: /\\b(webhook\\.site|requestbin|pipedream\\.net|hookbin|burpcollaborator|interact\\.sh|canarytokens|ngrok\\.io|localtunnel)\\b/i"
    enforcement: halt
    description: "Block web_fetch requests to known data exfiltration endpoints"
    severity: critical
    applies_to:
      - exec
      - bash
      - web_fetch
      - web_search
      - browser

  - id: INV_ESCALATE_DESTRUCTIVE_OPS
    rule: "regex_deny pattern: /\\brm\\b.*(-r\\b.*-f\\b|-f\\b.*-r\\b|--recursive|--force|-rf\\b|-fr\\b)/i"
    enforcement: warn
    description: "Escalate recursive/forced deletion commands regardless of flag ordering"
    severity: high

  - id: INV_NO_CREDENTIAL_HARVESTING
    rule: "regex_deny pattern: /\\b(find|locate|grep|rg|ag|printenv)\\b.*(\\.env|\\.pem|\\.key|secret|credential|password|authorized_keys|api.?key|smtp|sendgrid|resend|postmark)/i"
    enforcement: halt
    description: "Block credential hunting commands that search for sensitive files"
    severity: critical

  - id: INV_NO_KEYCHAIN_ACCESS
    rule: "regex_deny pattern: /\\bsecurity\\s+(find-generic-password|find-internet-password|dump-keychain)\\b/i"
    enforcement: halt
    description: "Block macOS keychain credential extraction via security CLI"
    severity: critical

  - id: INV_ESCALATE_SCRIPT_EXEC
    rule: "regex_deny pattern: /\\b(python[23]?|node|ruby|perl|bash|sh|zsh)\\s+\\S+\\.(py|js|rb|pl|sh|zsh)\\b/i"
    enforcement: warn
    description: "Escalate execution of script files through exec for review"
    severity: high
